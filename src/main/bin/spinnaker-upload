#!/bin/bash

: "${DCC_HOME:?Set DCC_HOME}"
: "${ACCESS_TOKEN:?Need to set environment variable ACCESS_TOKEN}"
: "${REDWOOD_ENDPOINT:?Need to set environment variable REDWOOD_ENDPOINT to e.g. storage.ucsc-cgl.org}"
: "${UCSC_STORAGE_TRUSTSTORE_PASSWORD:?Need to set environment variable UCSC_STORAGE_TRUSTSTORE_PASSWORD}"


script_name=`basename $0`

function log {
  logf "$*\n"
}

function logf {
  if [ $dev -ne 0 ]; then
    printf "${script_name}: $@" >&2
  fi
}

function help {
  cat <<EOF
Usage: ${script_name} [-h] [-d] [-p] file...

Upload a file to Redwood with Spinnaker

Options
  -h show this help message
  -d show debug output
  -p use http to call server; disable https
EOF
}


dev=0
http=0

while getopts ":hdp" opt; do
  case $opt in
    h)
      help
      exit
      ;;
    d)
      dev=1
      log "dev mode enabled"
      ;;
    p)
      http=1
      ;;
    \?)
      log "Invalid option: -$OPTARG"
      ;;
  esac
done
shift "$((OPTIND - 1))"
log "running ${script_name} with http=${http}, dev=${dev}"


function main {
  # config
  [[ $http -eq 1 ]] && protocol='http://' || protocol='https://'
  accessToken=${ACCESS_TOKEN}
  metadata_server_url=${protocol}metadata.${REDWOOD_ENDPOINT}
  storage_server_url=${protocol}storage.${REDWOOD_ENDPOINT}
  tsv_file=$1

  # Go to the right directory and execute the script
  cd ${DCC_HOME}/dcc-spinnaker-client
  echo python spinnaker.py \
    --input-metadata-schema schemas/input_metadata.json \
    --metadata-schema schemas/metadata_schema.json \
    --output-dir ../data/spinnaker/output_metadata \
    --receipt-file receipt.tsv \
    --storage-client-path ${DCC_HOME}/dcc-spinnaker-client/ucsc-storage-client \
    --force-upload \
    --storage-access-token ${ACCESS_TOKEN} \
    ${tsv_file}
}

main "$@"
