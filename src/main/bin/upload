#!/bin/bash
set -x
#
# Usage: ucsc-upload.sh dataFile...
#

: "${DCC_HOME:?Set DCC_HOME to directory containing ucsc-storage-client}"
: "${ACCESS_TOKEN:?Need to set environment variable ACCESS_TOKEN}"
: "${REDWOOD_ENDPOINT:?Need to set environment variable REDWOOD_ENDPOINT to e.g. storage.ucsc-cgl.org}"
: "${UCSC_STORAGE_TRUSTSTORE_PASSWORD:?Need to set environment variable UCSC_STORAGE_TRUSTSTORE_PASSWORD}"

# setup
uuid=`uuidgen`
echo using tmp dir $uuid
upload=`mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir'`/upload/${uuid}
manifest=`mktemp -d 2>/dev/null || mktemp -d -t 'mytmpdir'`/manifest/${uuid}
mkdir -p ${upload}
mkdir -p ${manifest}
cp $* ${upload}

# config
accessToken=${ACCESS_TOKEN}
metadata_server_url=https://${REDWOOD_ENDPOINT}:8444
storage_server_url=https://${REDWOOD_ENDPOINT}:5431
trust_store_path=${DCC_HOME}/ucsc-storage-client/conf/cacerts
trust_store_pass=${UCSC_STORAGE_TRUSTSTORE_PASSWORD}

# register upload
echo Registering upload:
java -Djavax.net.ssl.trustStore=${trust_store_path} -Djavax.net.ssl.trustStorePassword=${trust_store_pass} -Dserver.baseUrl=${metadata_server_url} -DaccessToken=${accessToken} -jar ${DCC_HOME}/ucsc-storage-client/lib/dcc-metadata-client-0.0.16-SNAPSHOT/lib/dcc-metadata-client.jar -i ${upload} -o ${manifest} -m manifest.txt

# perform upload
echo Performing upload:
java -Djavax.net.ssl.trustStore=${trust_store_path} -Djavax.net.ssl.trustStorePassword=${trust_store_pass} -Dmetadata.url=${metadata_server_url} -Dmetadata.ssl.enabled=true -Dclient.ssl.custom=false -Dstorage.url=${storage_server_url} -DaccessToken=${accessToken} -jar ${DCC_HOME}/ucsc-storage-client/lib/icgc-storage-client-1.0.14-SNAPSHOT/lib/icgc-storage-client.jar upload --manifest ${manifest}/manifest.txt

# cleanup
rm -r ${upload}
rm -r ${manifest}
