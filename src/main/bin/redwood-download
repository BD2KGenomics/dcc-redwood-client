#!/bin/bash

: "${DCC_HOME:?Need to set environment variable DCC_HOME}"
: "${REDWOOD_ENDPOINT:?Set environment variable REDWOOD_ENDPOINT to e.g. storage.ucsc-cgl.org}"
: "${UCSC_STORAGE_TRUSTSTORE_PASSWORD:?Need to set environment variable UCSC_STORAGE_TRUSTSTORE_PASSWORD}"

script_name=`basename $0`

function log {
  logf "$1\n"
}

function logf {
  if [ $dev -ne 0 ]; then
    printf "${script_name}: $@" >&2
  fi
}

function help {
  cat <<EOF
Usage: ${script_name} [-h] [-d] [-p] manifest.txt output_dir

Download files via manifest from Redwood.

Options
  -h show this help message
  -d show debug output
  -p use http to call server; disable https
EOF
}


dev=0
http=0

while getopts ":hdp" opt; do
  case $opt in
    h)
      help
      exit
      ;;
    d)
      dev=1
      log "dev mode enabled"
      ;;
    p)
      http=1
      ;;
    \?)
      log "Invalid option: -$OPTARG"
      ;;
  esac
done
log "running ${script_name} with http=${http}, dev=${dev}"


function main {
  # config
  [[ $http -eq 1 ]] && protocol='http://' || protocol='https://'
  #Seeing whether the access token is present as either a file or a by itself
  accessToken=${ACCESS_TOKEN}
  if [[ -z "$accessToken" ]]
  then accessToken=$(cat token/${ACCESS_TOKEN_FILE})
    if [[ -z "$accessToken" ]]
    then echo "Error: Need to set environment variable ACCESS_TOKEN or ACCESS_TOKEN_FILE" && exit 1
    else echo "Using ACCESS_TOKEN_FILE"
    fi
  else echo "Using ACCESS_TOKEN"
  fi

  metadata_server_url=${protocol}${REDWOOD_ENDPOINT}:8444
  storage_server_url=${protocol}${REDWOOD_ENDPOINT}:5431
  trust_store_path=${DCC_HOME}/cert/clientcacerts
  trust_store_pass=${UCSC_STORAGE_TRUSTSTORE_PASSWORD}

  # setup
  object=$1
  download=$2

  #Modify the object so that it can be used with the download script. That way you don't have to worry about the format.
  #Use 'awk'; example: awk 'BEGIN {FS="\t";OFS="\t"}; { t=$1 ; $1=$3; $3=t; print $1, $2, $3}' manifest.tsv > test.tsv 
  #This will first swap column 1 with column 3 and  output the first three colums to test. 
  #awk 'BEGIN {FS="\t";OFS="\t"}; { t=$3 ; $3=$17; $17=t; print}' ${object} | cut -f1-11  > data/temp.tsv
  awk 'BEGIN {FS="\t";OFS="\t"}; NR==1{for(i=1;i<=NF;i++){if($i=="Upload File ID" || $i=="File ID"){c=i;break}} t=$3 ; $3=$c; $c=t; print } NR>1{t=$3 ; $3=$c; $c=t; print}' ${object} | cut -f1-11  > data/temp.tsv
  
  # download files in a manifest
  [[ $http -eq 1 ]] && ssl_opts='' || ssl_opts="-Djavax.net.ssl.trustStore=${trust_store_path} -Djavax.net.ssl.trustStorePassword=${trust_store_pass}  -Dmetadata.ssl.enabled=true -Dclient.ssl.custom=false"
  java ${ssl_opts}  -Dmetadata.url=${metadata_server_url} -Dstorage.url=${storage_server_url} -DaccessToken=${accessToken} -jar ${DCC_HOME}/lib/icgc-storage-client-1.0.14-SNAPSHOT/lib/icgc-storage-client.jar download --output-dir ${download} --output-layout bundle --manifest data/temp.tsv  --force

  rm data/temp.tsv
  #Change ownership of the files in data/ from root to the current user.
  user=$(stat -c '%u:%g' data/)
  if [[ ! -z "$user" ]]
  then  chown -R ${user} data/
  fi
}


main "$@"
